---
title: Конифгурация плагина для работы с БД в LazyVim
date: 2024-11-03 17:00:00 +0300
categories: [Vim]
tags: [LazyVim, Postgresql, dadbod-ui]
---

В этой статье мы рассмотрим, как настроить плагин **vim-dadbod-ui** для работы с базой данных в редакторе **LazyVim**. Следуйте приведённым ниже шагам, чтобы интегрировать вашу PostgreSQL базу данных в LazyVim и воспользоваться всеми преимуществами удобного пользовательского интерфейса для управления базами данных.

## Шаг 1: Создание или обновление файла конфигурации плагинов

1. Создайте файл `plugins.lua` внутри директории `~/.config/nvim/lua/plugins`:
```
mkdir -p ~/.config/nvim/lua/plugins
touch ~/.config/nvim/lua/plugins/plugins.lua
```
2. Если файл `plugins.lua` уже существует, добавьте конфигурацию из шага 2 в конец файла.

## Шаг 2: Конфигурация плагина `vim-dadbod-ui`

Добавьте следующий код в файл `plugins.lua`:
```lua
{
  "kristijanhusak/vim-dadbod-ui",
  dependencies = {
    { "tpope/vim-dadbod", lazy = true },
    { 
      "kristijanhusak/vim-dadbod-completion", 
      ft = { "sql", "mysql", "plsql" }, 
      lazy = true 
    }, -- Опционально
  },
  cmd = {
    "DBUI",
    "DBUIToggle",
    "DBUIAddConnection",
    "DBUIFindBuffer",
  },
  keys = {
    { "<leader>D", "<cmd>DBUI<CR>", desc = "Открыть DBUI" },
    { "<leader>Dt", "<cmd>DBUIToggle<CR>", desc = "Переключить DBUI" },
    { "<leader>DA", "<cmd>DBUIAddConnection<CR>", desc = "Добавить подключение к БД" },
    { "<leader>DF", "<cmd>DBUIFindBuffer<CR>", desc = "Найти буфер DBUI" },
  },
  init = function()
    -- Конфигурация DBUI
    vim.g.db_ui_save_location = vim.fn.stdpath("data") .. "/db_ui_state.vim"
    vim.g.db_ui_winwidth = 50
    vim.g.db_ui_winheight = 15
    vim.g.db_ui_icons = {
      expanded = "▾",
      collapsed = "▸",
      new_connection = "+",
      connection_ok = "✓",
      connection_error = "✕",
    }

    -- Шаблон для подключений PostgreSQL
    -- Пример: postgres://username:password@host:port/database
    vim.g.db_ui_connection_patterns = {
      ["postgres"] = {
        pattern = "^postgres://(\\w+):(\\w+)@",
        driver = "postgres",
      },
    }
    vim.g.db_ui_use_nerd_fonts = 1
  end,
},
```

### Детали конфигурации плагина `vim-dadbod-ui`

#### 1. Объявление плагина
```lua
{
  "kristijanhusak/vim-dadbod-ui",
  dependencies = {
    { "tpope/vim-dadbod", lazy = true },
    { "kristijanhusak/vim-dadbod-completion", ft = { "sql", "mysql", "plsql" }, lazy = true },
  },
  -- Дополнительные поля конфигурации...
}
```
- `kristijanhusak/vim-dadbod-ui` - Основной плагин, предоставляющий пользовательский интерфейс для взаимодействия с базами данных непосредственно в Neovim. Он позволяет управлять подключениями, выполнять запросы и просматривать результаты.

- `dependencies` - Здесь указываются другие плагины, на которые полагается `vim-dadbod-ui` для корректной работы:

  - `tpope/vim-dadbod` - Основной плагин для интеграции с базой данных, обеспечивающий функциональность подключения и выполнения запросов.
  - `kristijanhusak/vim-dadbod-completion` - Опциональный плагин, предоставляющий функции автозаполнения для различных типов баз данных. В данном примере функция автозаполнения будет загружаться только для типов: `sql, mysql, plsql`.
`lazy = true` - Указывает на ленивую загрузку плагинов, то есть они будут загружены только по мере необходимости, что оптимизирует время запуска LazyVim.

Объявляя эти плагины и их зависимости, вы гарантируете, что все необходимые компоненты доступны и загружены эффективно. Ленивые загрузки помогают сократить время начальной загрузки LazyVim, откладывая загрузку плагинов до момента, когда они действительно потребуются.

#### 2. Перечисление команд

```lua
cmd = {
  "DBUI",
  "DBUIToggle",
  "DBUIAddConnection",
  "DBUIFindBuffer",
},
```

В блоке `cmd` указывается список команд, связанных с плагином:

- `DBUI`: Открывает интерфейс DBUI.
- `DBUIToggle`: Переключает видимость окна DBUI.
- `DBUIAddConnection`: Запускает процесс добавления нового подключения к базе данных.
- `DBUIFindBuffer`: Находит и открывает существующий буфер DBUI.

Указывая эти команды, LazyVim понимает, что загружать плагин `vim-dadbod-ui` требуется только при попытке использовать одну из этих команд. Это предотвращает ненужную загрузку плагина во время обычных сеансов редактирования, когда взаимодействие с базой данных не требуется.

#### 3. Добавление горячих клавиш

```lua
keys = {
  { "<leader>D", "<cmd>DBUI<CR>", desc = "Открыть DBUI" },
  { "<leader>Dt", "<cmd>DBUIToggle<CR>", desc = "Переключить DBUI" },
  { "<leader>DA", "<cmd>DBUIAddConnection<CR>", desc = "Добавить подключение к БД" },
  { "<leader>DF", "<cmd>DBUIFindBuffer<CR>", desc = "Найти буфер DBUI" },
},
```

`keys` - массив, определяющий пользовательские привязки клавиш для плагина. Каждый объект содержит три параметра:
  1. Комбинация клавиш: Например, `<leader>D`.
  2. Команда для выполнения: Например, `<cmd>DBUI<CR>`.
  3. Описание: Для отображения подсказок в плагине which-key.nvim.

Эти привязки клавиш обеспечивают быстрый доступ к функциям интерфейса `vim-dadbod-ui` без необходимости вводить полные команды, что повышает производительность.

#### Инициализация (конфигурация плагина)

```lua
init = function()
  -- Конфигурация DBUI
  vim.g.db_ui_save_location = vim.fn.stdpath("data") .. "/db_ui_state.vim"
  vim.g.db_ui_winwidth = 50
  vim.g.db_ui_winheight = 15
  vim.g.db_ui_icons = {
    expanded = "▾",
    collapsed = "▸",
    new_connection = "+",
    connection_ok = "✓",
    connection_error = "✕",
  }

  -- Шаблон для подключений PostgreSQL
  -- Пример: postgres://username:password@host:port/database
  vim.g.db_ui_connection_patterns = {
    ["postgres"] = {
      pattern = "^postgres://(\\w+):(\\w+)@",
      driver = "postgres",
    },
  }
  vim.g.db_ui_use_nerd_fonts = 1
end,
```
Эта функция выполняется при загрузке плагина и настраивает различные параметры интерфейса:

- `vim.g.db_ui_save_location` - Указывает, где сохраняется состояние DBUI (например, открытые подключения и настройки). Использует стандартный каталог данных Neovim.
- `vim.g.db_ui_winwidth` и `vim.g.db_ui_winheight` - Задают ширину и высоту окна DBUI по умолчанию.
- `vim.g.db_ui_icons` - Определяет иконки, используемые в интерфейсе DBUI для различных элементов.
- `vim.g.db_ui_connection_patterns` - Определяет шаблоны для распознавания строк подключения к базе данных. В данном случае настроен шаблон для PostgreSQL.
- `vim.g.db_ui_use_nerd_fonts` - Включает использование Nerd шрифтов для отображения иконок.

Эти настройки позволяют адаптировать внешний вид и поведение плагина vim-dadbod-ui под ваши предпочтения, обеспечивая удобство и эффективность при работе с базой данных.

## Шаг 3: Завершение конфигурации

1. Сохраните изменения в файле `plugins.lua`.
2. Перезапустите LazyVim, чтобы применить новые настройки.
3. Откройте окно LazyVim (по умолчанию, нажмите `<leader>l`) и синхронизируйте все плагины: `:Lazy sync`

## Шаг 4: Использование плагина `vim-dadbod-ui`

После завершения конфигурации у вас появятся следующие горячие клавиши для работы с DBUI:

- `<leader>D` — открыть меню DBUI.
- `<leader>Dt` — переключить видимость DBUI.
- `<leader>DA` — добавить новое подключение к базе данных.
- `<leader>DF` — открыть буфер поиска DBUI.

## Подключение к базе данных

1. Откройте LazyVim
2. Откройте меню DBUI используя клавиши `<leader>Dt` или введите команду `:DBUI` (данная команда необязательна для подключения, но дальнейшую навигацию после подключения будет удобно делать через этот интерфейс)
3. Далее с помощью команды `<leader>DA` вызвать интерфейс ввода URL и ввести данные до вашей БД в формате: `postgres://postgres:mysecretpassword@localhost:5432/mydatabase`

## Заключение

Настроив плагин vim-dadbod-ui в LazyVim, вы получаете мощный инструмент для взаимодействия с вашей базой данных непосредственно из редактора. Это позволяет эффективно управлять подключениями, выполнять SQL-запросы и просматривать результаты без необходимости переключаться между разными приложениями.

Автоматическая загрузка и применение настроек при запуске LazyVim упрощают процесс работы с базой данных, делая его более интуитивным и быстрым.
